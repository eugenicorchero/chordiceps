<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chordiceps: Entrenador Auditiu d'Acords</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0b1122;
    }
    #playButton {transition: all 0.1s ease;box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3),0 2px 4px -2px rgba(0,0,0,0.2);}
    #playButton:hover:not(:disabled) {transform: scale(1.05);box-shadow: 0 10px 15px -3px rgba(37,99,235,0.4),0 4px 6px -4px rgba(37,99,235,0.3);}
    #progressBar {transition: width 0.9s linear;}
    .audio-error-popup {position: fixed;top: 20px;right: 20px;z-index: 50;}
    .difficulty-button {background-color:#2563eb;transition:all 0.15s ease;box-shadow:0 4px 14px 0 rgba(37,99,235,0.5);}
    .difficulty-button:hover{background-color:#1d4ed8;}
    .loading-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(11,17,34,0.9);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:1rem;z-index:60;color:white;font-size:1.25rem;border-radius:0.75rem;padding:2rem;}
  </style>
</head>

<body class="bg-gray-950 min-h-screen flex flex-col items-center justify-center p-4">

  <div id="audioErrorPopup" class="audio-error-popup hidden bg-red-600 text-white p-3 rounded-lg shadow-xl max-w-sm transition duration-300 transform scale-100">
    <p class="font-bold mb-1">‚ö†Ô∏è Error de Prec√†rrega</p>
    <p id="audioErrorMessage" class="text-sm">No s'han pogut carregar tots els fitxers d'acord.</p>
    <p class="text-xs mt-1 opacity-80">Revisa la nomenclatura de l'arxiu que no es troba.</p>
  </div>

  <div id="appContainer" class="bg-gray-800 shadow-2xl rounded-xl w-full max-w-4xl p-8 md:p-12 border border-gray-700/50 mb-4 relative">

    <div id="loadingOverlay" class="loading-overlay">
      <p class="text-center font-semibold">Carregant fitxers d'√†udio per a un joc instantani...</p>
      <div class="w-full bg-gray-600 rounded-full h-2.5 max-w-sm">
        <div class="h-2.5 bg-blue-500 rounded-full transition-all duration-300" id="preloaderBar" style="width: 0%"></div>
      </div>
      <p class="text-base text-gray-300" id="preloaderStatus"></p>
    </div>

    <div id="difficultyScreen" class="opacity-0 transition-opacity duration-500">
      <header class="text-center mb-8 border-b border-blue-600 pb-4">
        <h1 class="text-4xl font-extrabold text-white tracking-tight">Chordiceps</h1>
        <p class="text-xl text-blue-400 font-semibold mt-1">Entrenador Auditiu d'Acords</p>
      </header>

      <h2 class="text-2xl font-bold text-gray-100 mb-2 text-center">Benvingut/da! Tria el teu Nivell de Pr√†ctica</h2>
      <p class="text-gray-400 text-center mb-8 max-w-xl mx-auto">Practica la identificaci√≥ d'acords. La fonamental √©s aleat√≤ria (de C3 a B3), per√≤ el tipus d'acord √©s l'√∫nic que has de recon√®ixer. Tria el teu nivell.</p>

      <div class="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto">
        <button onclick="startGame('easy')" class="difficulty-button text-white font-semibold rounded-lg p-6 flex flex-col items-center text-center">
          <span class="text-xl font-bold mb-2">F√†cil (Tr√≠ades B√†siques)</span>
          <span class="text-sm opacity-90">Acords: Maj, Men.</span>
        </button>
        <button onclick="startGame('medium')" class="difficulty-button text-white font-semibold rounded-lg p-6 flex flex-col items-center text-center">
          <span class="text-xl font-bold mb-2">Mitj√† (Totes les Tr√≠ades)</span>
          <span class="text-sm opacity-90">Acords: Maj, Men, Aug, Dism.</span>
        </button>
        <button onclick="startGame('hard')" class="difficulty-button text-white font-semibold rounded-lg p-6 flex flex-col items-center text-center">
          <span class="text-xl font-bold mb-2">Dif√≠cil (Tots els 10 Acords)</span>
          <span id="hardChordsList" class="text-sm opacity-90">Carregant llista d'acords...</span>
        </button>
      </div>
    </div>

    <div id="quizScreen" class="hidden">
      <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
        <div class="text-xl font-medium text-gray-300">Ronda: <span id="roundCount" class="font-bold text-blue-400">1</span></div>
        <div class="text-xl font-medium text-gray-300">Puntuaci√≥: <span id="score" class="font-bold text-blue-400">0</span></div>
      </div>
      <div class="text-center mb-8">
        <button id="playButton" class="bg-blue-600 text-white p-4 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4 hover:bg-blue-700 transition duration-200 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
          </svg>
        </button>
        <p id="directionLabel" class="text-lg font-semibold text-gray-300 mb-4">Reconeix l'Acord</p>
        <p id="debugNotes" class="hidden text-xs text-gray-500 mb-2"></p>
        <div class="w-full bg-gray-700 rounded-full h-2.5">
          <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 100%"></div>
        </div>
        <p class="text-sm text-gray-400 mt-2">Temps restant per respondre: <span id="timeRemaining">30</span>s</p>
      </div>
      <div id="intervalOptions" class="grid gap-3 mt-8" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));"></div>
      <div id="feedbackMessage" class="mt-6 text-center text-lg font-bold min-h-6"></div>
      <button id="nextRoundButton" class="hidden w-full py-3 mt-6 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 shadow-lg">
        Seg√ºent Ronda
      </button>
    </div>

    <div id="resultScreen" class="hidden text-center">
      <h2 class="text-3xl font-bold text-gray-100 mb-4">Resultats Finals</h2>
      <p class="text-xl text-gray-400 mb-6">Has completat la pr√†ctica!</p>
      <p class="text-4xl font-extrabold text-blue-400 mb-8">Puntuaci√≥ Final: <span id="finalScore">0</span></p>
      <button onclick="resetGame()" class="w-full py-4 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">Tornar a comen√ßar</button>
    </div>

  </div>

  <footer class="text-center text-sm text-gray-400 mt-4 max-w-4xl w-full">
    <p>Copyright &copy; Eugeni Corchero 2025 (Adaptat per Chordiceps)</p>
  </footer>

  <script>
    const AUDIO_PATH = './audios/';
    const MIDI_START = 48, MIDI_END = 59, TOTAL_MIDI_ROOTS = MIDI_END - MIDI_START + 1;
    const TIMER_DURATION = 30;
    const audioCache = {};

    const CHORD_ABBREVIATIONS = {'Maj':'Maj','Men':'Men','Aug':'Aug','Dim':'Dism','Maj7':'Maj 7','Dom7':'Dom 7','Men7':'Men 7','m7b5':'m7b5','Dim7':'Dism 7','AugM7':'Aug M7'};
    const ALL_CHORDS = Object.keys(CHORD_ABBREVIATIONS);
    const DIFFICULTY_CONFIG = {easy:{chords:['Maj','Men']},medium:{chords:['Maj','Men','Aug','Dim']},hard:{chords:ALL_CHORDS}};

    let gameState = {difficulty:null,score:0,round:0,correctChordType:null,timer:null,timeRemaining:TIMER_DURATION,isAnswered:false,baseNoteMIDI:null,currentChordLabel:null,isAudioReady:false};

    const screens={difficulty:document.getElementById('difficultyScreen'),quiz:document.getElementById('quizScreen'),result:document.getElementById('resultScreen')};
    const elements={roundCount:roundCount= document.getElementById('roundCount'),score:document.getElementById('score'),playButton:document.getElementById('playButton'),progressBar:document.getElementById('progressBar'),timeRemaining:document.getElementById('timeRemaining'),intervalOptions:document.getElementById('intervalOptions'),feedbackMessage:document.getElementById('feedbackMessage'),nextRoundButton:document.getElementById('nextRoundButton'),directionLabel:document.getElementById('directionLabel'),finalScore:document.getElementById('finalScore'),audioErrorPopup:document.getElementById('audioErrorPopup'),audioErrorMessage:document.getElementById('audioErrorMessage'),loadingOverlay:document.getElementById('loadingOverlay'),preloaderBar:document.getElementById('preloaderBar'),preloaderStatus:document.getElementById('preloaderStatus'),hardChordsList:document.getElementById('hardChordsList')};

    function getFileRootName(midi){const n=['C','Cs','D','Ds','E','F','Fs','G','Gs','A','As','B'];const o=Math.floor(midi/12)-1;const i=midi%12;return `${n[i]}${o}`;}
    function getFileName(midi,chordType){return `${AUDIO_PATH}${getFileRootName(midi)}-${chordType}.mp3`; }

    // üîä Prec√†rrega amb timeout i c√†rrega per lots segura per iOS
    function preloadAllAudio(batchSize=8){
      return new Promise(async(resolve,reject)=>{
        const totalChords=ALL_CHORDS.length;
        const totalFiles=TOTAL_MIDI_ROOTS*totalChords;
        let filesLoaded=0,errors=0,failed=[];
        elements.loadingOverlay.classList.remove('hidden');
        elements.preloaderStatus.textContent='Carregant √†udios...';
        const all=[];
        for(let m=MIDI_START;m<=MIDI_END;m++){
          for(const chord of ALL_CHORDS){
            all.push({fileKey:`${m}-${chord}`,fileURL:getFileName(m,chord)});
          }
        }
        const update=()=>{const p=Math.round((filesLoaded/totalFiles)*100);elements.preloaderBar.style.width=`${p}%`;elements.preloaderStatus.textContent=`Carregats ${filesLoaded}/${totalFiles} acords. ${errors>0?'('+errors+' errors)':''}`;};
        for(let i=0;i<all.length;i+=batchSize){
          const batch=all.slice(i,i+batchSize);
          const proms=batch.map(item=>new Promise(res=>{
            const audio=new Audio(item.fileURL);
            audio.preload='auto';
            audioCache[item.fileKey]=audio;
            let done=false;
            const finish=(err)=>{if(done)return;done=true;filesLoaded++;if(err){errors++;failed.push(item.fileURL);console.warn(`‚ö†Ô∏è Error ${item.fileURL}`);}update();res();};
            audio.oncanplaythrough=()=>finish(false);
            audio.onerror=()=>finish(true);
            setTimeout(()=>{if(!done){console.warn(`‚è≥ Timeout: ${item.fileURL}`);finish(true);}},8000);
            try{audio.load();}catch(e){finish(true);}
          }));
          await Promise.all(proms);
          await new Promise(r=>setTimeout(r,300));
        }
        if(errors===0){elements.preloaderStatus.textContent='Prec√†rrega completada. Preparant joc...';setTimeout(resolve,600);}
        else{elements.preloaderStatus.textContent=`Prec√†rrega finalitzada amb ${errors} errors.`;reject({errorCount:errors,failedUrls:failed});}
      });
    }

    function checkAudioAccessibility(){
      preloadAllAudio().then(()=>{
        gameState.isAudioReady=true;
        elements.loadingOverlay.classList.add('hidden');
        screens.difficulty.classList.remove('opacity-0');
      }).catch(e=>{
        gameState.isAudioReady=false;
        elements.loadingOverlay.classList.add('hidden');
        screens.difficulty.classList.remove('opacity-0');
        alert("Error de prec√†rrega d'√†udios");
      });
    }

    function playChord(){
      const key=`${gameState.baseNoteMIDI}-${gameState.correctChordType}`;
      const audio=audioCache[key];
      if(audio)audio.play();
    }

    function showScreen(id){Object.values(screens).forEach(s=>s.classList.add('hidden'));screens[id].classList.remove('hidden');}
    function startGame(d){gameState.difficulty=d;gameState.score=0;gameState.round=0;elements.score.textContent=0;showScreen('quiz');loadNextRound();}
    function generateChord(){const chords=DIFFICULTY_CONFIG[gameState.difficulty].chords;const chord=chords[Math.floor(Math.random()*chords.length)];const midi=Math.floor(Math.random()*(MIDI_END-MIDI_START+1))+MIDI_START;return{correctChordType:chord,baseNoteMIDI:midi,label:chord};}
    function loadNextRound(){gameState.round++;const c=generateChord();gameState.correctChordType=c.correctChordType;gameState.baseNoteMIDI=c.baseNoteMIDI;gameState.currentChordLabel=c.label;elements.roundCount.textContent=gameState.round;elements.directionLabel.textContent=`Reconeix l'Acord (Fonamental: ${gameState.baseNoteMIDI})`;playChord();}
    function resetGame(){showScreen('difficulty');}

    window.onload=()=>{elements.playButton.onclick=playChord;checkAudioAccessibility();}
  </script>
</body>
</html>
